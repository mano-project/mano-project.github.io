<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" translate="no" class="notranslate">
  <head>
      <title>MANO - Metadata Collection</title>
      <meta name="keywords" content="MANO, Manuscripts Online, Metadata Collection">
      <meta name="description" content="">
      <meta charset="UTF-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0 shrink-to-fit=no"/>
      <meta name="google" content="notranslate"/>
      <link rel="canonical" href="https://mano-project.github.io/collection.html"/>
      <link rel="icon" type="image/png" href="images/MANO.png"> 
      
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
              
      <link rel="stylesheet" type="text/css" href="css/style.css" media="screen"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  </head>
  <body>
    <nav class="navbar bg-body-tertiary ">
        <div class="container-fluid d-flex justify-content-between align-items-center position-relative py-2">

            <!-- Invisible spacer to balance layout -->
            <div style="width: 80px;"></div>

            <!-- Centered logo -->
            <div class="position-absolute start-50 translate-middle-x text-center">
            <a class="navbar-brand" href="index.html">
                <img src="images/MANO.png" alt="Logo" width="80" class="d-inline-block align-text-top">
            </a>
            </div>

            <!-- Offcanvas toggle aligned right -->
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
            aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
            </button>

            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasNavbarLabel">&lt;MANO&gt;</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="resources.html">Resources</a></li>
                <li class="nav-item"><a class="nav-link" href="editor.html">Metadata Editor</a></li>
                <li class="nav-item"><a class="nav-link active" href="collection.html">Metadata Collection</a></li>
                <li class="nav-item"><a class="nav-link" href="viewer.html">Transcription Viewer</a></li>
                <!--<li class="nav-item"><a class="nav-link" href="contacts.html">Contacts</a></li>-->
                </ul>
            </div>
            </div>
        </div>
    </nav>

    
    
      <div class="container mt-4 mb-5">
          
        <div class="container">
          <button onclick="history.back()" class="btn btn-sm btn-outline-secondary">&larr; Back</button>
        </div>
        <h1 class="page-title">Metadata Collection</h1>

        <div class="row my-4 align-items-end">
          <!-- Left column -->
          <div class="col-12 col-md-6 d-flex justify-content-start mb-2 mb-md-0">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#infoMetadataCollection">
              About Metadata Collection
            </button>
          </div>

          <!-- Right column -->
          <div class="col-12 col-md-6 d-flex justify-content-start justify-content-md-end">
            <a href="https://github.com/mano-project/mano-metadata/tree/main/data" 
              class="btn btn-primary" 
              target="_blank" 
              rel="noopener noreferrer">
              Contribute to the Collection <i class="fab fa-github fa-xl ms-2"></i>
            </a>
          </div>
        </div>


        <!-- About Metadata Editor Modal -->
        <div class="modal fade" id="infoMetadataCollection" tabindex="-1" aria-labelledby="infoMetadataCollectionLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="infoMetadataCollectionLabel">About Metadata Collection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>The Metadata Collection provides an overview of all manuscript descriptions that have been contributed by users into the MANO project repository. Each row in the table represents a single manuscript, with metadata such as title, repository, location, material, and links to digital copies. The filtering interface allows the metadata to be refined by country, century, responsible person, or by searching titles and repositories.</p>
                <p>To contribute new metadata, manuscripts must first be described in the <a href="editor.html">Metadata Editor</a> and downloaded in JSON format. The resulting JSON file can then be uploaded directly to the <a href="https://github.com/mano-project/mano-metadata/tree/main/data" target="_blank">MANO GitHub repository</a>, or by clicking the "Contribute to the Collection" button on this page. After the submission is reviewed and accepted by the project team, the new records will automatically appear in this collection.
                </p>
                <p>Contributors must have a GitHub account in order to submit files directly. Alternatively, metadata files may be sent via email to the project team, who will handle the upload process. Every contribution helps expand the shared digital resource, and participation in enriching the Metadata Collection is greatly appreciated.
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <!--<div class="row mb-4 mt-5">
          <div class="col-md-6">
            <input id="searchInput" class="form-control" type="text" placeholder="Search manuscripts..." oninput="filterTable()">
          </div>
        </div>-->

        <div class="row mb-4 mt-5 align-items-center">
          <div class="col-md-6">
            <input id="searchInput" class="form-control" type="text" placeholder="Search manuscripts..." oninput="applyFilters()">
          </div>
          <div class="col-md-6 text-end mt-2 mt-md-0">
            <button class="btn btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
              <i class="fas fa-filter"></i> Filters
            </button>
          </div>
        </div>

        <!-- Bootstrap Offcanvas Filters -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas">
          <div class="offcanvas-header">
            <h5>Filter Manuscripts</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
          </div>
          <div class="offcanvas-body">
            <div id="filterSections">
              <!-- Dynamic filters will be injected here -->
            </div>
            <button id="resetFilters" class="btn btn-sm btn-secondary mt-3">Reset Filters</button>
          </div>
        </div>


        

        <!-- Responsive Table -->
        <div class="table-responsive">
          <table class="table table-hover" id="metadataTable">
            <thead>
              <tr>
                <th>Manuscript Title</th>
                <th>Repository</th>
                <th>Location</th>
                <th>Digital Copy</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Rows populated dynamically -->
            </tbody>
          </table>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="recordModalLabel">Manuscript Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="recordModalBody">
                <!-- JSON fields will be rendered here -->
              </div>
              <div class="modal-footer">
                <div class="dropdown">
                  <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Download
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="downloadJSON(currentRecord)">Download JSON</a></li>
                    <li><a class="dropdown-item" href="#" onclick="downloadXMLfromRecord(currentRecord)">Download XML</a></li>
                  </ul>
                </div>
                <button type="button" class="btn btn-primary"  onclick="printRecordAsPDF()">Print PDF</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>

            </div>
          </div>
        </div>
      </div>
    

      <footer class="footer bg-body-tertiary text-center py-4">
        <div class="container">

        <!-- Logo centered -->
        <div class="mb-3">
            <a class="navbar-brand" href="index.html">
            <img src="images/MANO.png" alt="Logo" width="80">
            </a>
        </div>

        <!-- Links centered in one line -->
        <div class="mb-3">
            <a class="footer-link mx-2" href="index.html">Home</a>
            <a class="footer-link mx-2" href="resources.html">Resources</a>
            <a class="footer-link mx-2" href="editor.html">Metadata Editor</a>
            <a class="footer-link mx-2" href="collection.html">Metadata Collection</a>
            <a class="footer-link mx-2" href="viewer.html">Transcription Viewer</a>
            <!--<a class="footer-link mx-2" href="contacts.html">Contacts</a>-->
        </div>

        <!-- Copyright centered -->
        <div class="text-center mt-2">
            <span>© 2025 <span class="mano">&lt;MANO&gt;</span></span>
        </div>

        </div>
      </footer>
    
    <script>
    const repoOwner = "mano-project";
    const repoName = "mano-metadata";
    const folderPath = "data";

    let allEntries = [];

    async function fetchFileList() {
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folderPath}`;
      const res = await fetch(apiUrl);
      const files = await res.json();
      return files.filter(file => file.name.endsWith(".json"));
    }

    async function fetchJSONFile(url) {
      const res = await fetch(url);
      return await res.json();
    }

    function getCentury(yearStr) {
      const year = parseInt(yearStr);
      if (isNaN(year)) return null;
      return Math.floor((year - 1) / 100) + 1;
    }


    function displayField(field) {
      if (!field) return "";
      if (typeof field === "object") {
        return field.value || ""; // just show the value
      }
      return field; // plain string
    }


    function createTableRow(entry) {
      const row = document.createElement("tr");

      // Always just the value
      const repoDisplay = displayField(entry.repository);
      const settlementDisplay = displayField(entry.settlementIdent);
      const countryDisplay = displayField(entry.countryIdent);
      const location = [settlementDisplay, countryDisplay].filter(Boolean).join(", ");

      const digiLink = entry.digi ? `<a href="${entry.digi}" target="_blank">View</a>` : "";

      row.innerHTML = `
        <td>${entry.msTitle || ""}</td>
        <td>${repoDisplay}</td>
        <td>${location}</td>
        <td>${digiLink}</td>
        <td>
          <div class="dropdown d-inline-block me-2">
            <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Download
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick='downloadJSON(${JSON.stringify(entry)})'>JSON</a></li>
              <li><a class="dropdown-item" href="#" onclick='downloadXMLfromRecord(${JSON.stringify(entry)})'>XML</a></li>
            </ul>
          </div>
          <button class="btn btn-sm btn-secondary" onclick='showFullRecord(${JSON.stringify(entry).replace(/'/g, "&apos;")})'>See complete record</button>
        </td>
      `;

      // Fix dataset values for filtering
      row.dataset.country = entry.countryIdent?.value || entry.countryIdent || "";
      row.dataset.century = getCentury(entry.dateOrigin) || "";
      row.dataset.persons = (entry.responsiblePersons || [])
        .map(p => `${p.name} ${p.surname}`.toLowerCase())
        .join(";");
      row.dataset.text = `${entry.msTitle || ""} ${repoDisplay}`.toLowerCase();

      return row;
    }



    let currentRecord = null;

    function showFullRecord(entry) {
      currentRecord = entry; 
      const modalBody = document.getElementById("recordModalBody");
      modalBody.innerHTML = ""; 

      const addLink = (field) => {
        if (!field) return "";
        if (typeof field === "object" && field.value) {
          return field.uri ? `<a href="${field.uri}" target="_blank">${field.value}</a>` : field.value;
        }
        return field;
      };

      const section = (title, content) => `
        <div class="mb-4">
          <h5 class="border-bottom pb-1">${title}</h5>
          ${content || "<p><em>No data</em></p>"}
        </div>
      `;

      //FILE DESCRIPTION
      const fileDescription = `
        <p><strong>Manuscript Title:</strong> ${entry.msTitle || ""}</p>
        <p><strong>License:</strong> ${entry.publicationStmt || ""}</p>
        ${
          (entry.responsiblePersons && entry.responsiblePersons.length > 0)
            ? `<p><strong>Responsible Persons:</strong><ul>` +
              entry.responsiblePersons.map(p => `
                <li>
                  ${p.name || ""} ${p.surname || ""}
                  ${p.affiliation?.value ? `, ${addLink(p.affiliation)}` : ""}
                  ${p.ref ? ` (<a href="${p.ref}" target="_blank">External ID</a>)` : ""}
                </li>
              `).join("") +
              `</ul></p>`
            : ""
        }
      `;

      //IDENTIFICATION
      const identification = `
        <p><strong>Library:</strong> ${addLink(entry.repository)}</p>
        <p><strong>Settlement:</strong> ${addLink(entry.settlementIdent)}</p>
        <p><strong>Country:</strong> ${addLink(entry.countryIdent)}</p>
        <p><strong>Collection & Signature:</strong> ${entry.idno || ""}</p>
        <p><strong>Sigle:</strong> ${entry.msSigle || ""}</p>
        <p><strong>Alternative Identifier:</strong> ${entry.altIdentifier || ""}</p>
        <p><strong>Full Name:</strong> ${entry.msName || ""}</p>
      `;

      //CONTENT
      const contentSummary = `<p><strong>Summary:</strong> ${entry.summaryContents || ""}</p>`;
      const contentItems = (entry.msItems && entry.msItems.length > 0)
        ? entry.msItems.map((c, i) => `
          <div class="border rounded p-2 mb-2">
            <p><strong>Content ${i + 1}:</strong></p>
            <ul>
              <li><strong>Author:</strong> ${addLink(c.author)}</li>
              <li><strong>Title:</strong> ${c.title || ""}</li>
              <li><strong>Page Range(s):</strong> ${
                (c.pageRanges && c.pageRanges.length > 0)
                  ? c.pageRanges.map(r => `${r.from || ""}–${r.to || ""}`).join(", ")
                  : ""
              }</li>
              <li><strong>Incipit:</strong> ${c.incipit || ""}</li>
              <li><strong>Explicit:</strong> ${c.explicit || ""}</li>
              <li><strong>Textual Family:</strong> ${c.textFamily || ""}</li>
              <li><strong>Textual Subfamily:</strong> ${c.textSubFamily || ""}</li>
              <li><strong>Text Language:</strong> ${addLink(c.textLang)}</li>
              <li><strong>Text Genre:</strong> ${c.textGenre || ""}</li>
            </ul>
          </div>
        `).join("")
        : "";

      //PHYSICAL DESCRIPTION
      const physical = `
        <p><strong>Condition:</strong> ${entry.condition || ""}</p>
        <p><strong>Hands:</strong> ${entry.hands || ""}</p>
        <p><strong>Font Description:</strong> ${addLink(entry.script)}</p>
        <p><strong>Material:</strong> ${entry.material || ""}</p>
        <p><strong>Height:</strong> ${entry.height ? entry.height + " cm" : ""}</p>
        <p><strong>Width:</strong> ${entry.width ? entry.width + " cm" : ""}</p>
        <p><strong>Leaves:</strong> ${entry.leaves || ""}</p>
        <p><strong>Columns:</strong> ${entry.columns || ""}</p>
        <p><strong>Lines:</strong> ${entry.lines || ""}</p>
      `;

      //HISTORY
      const history = `
        <p><strong>Summary:</strong> ${entry.summaryProvenance || ""}</p>
        <p><strong>Place of Origin:</strong> ${addLink(entry.origPlace)} ${
          entry.countryOrigin ? `(${addLink(entry.countryOrigin)})` : ""
        }</p>
        <p><strong>Earliest Possible Date:</strong> ${entry.dateOriginNotBefore || ""}</p>
        <p><strong>Latest Possible Date:</strong> ${entry.dateOriginNotAfter || ""}</p>
        ${
          (entry.provenance && entry.provenance.length > 0)
            ? `<p><strong>Provenance(s):</strong><ul>` +
              entry.provenance.map(prov => `
                <li>
                  ${addLink(prov.name)} ${prov.type ? `(${prov.type})` : ""}
                  ${prov.settlement?.value ? `, ${addLink(prov.settlement)}` : ""}
                  ${prov.country?.value ? `, ${addLink(prov.country)}` : ""}
                  ${prov.date ? ` — Period: ${prov.date}` : ""}
                </li>
              `).join("") +
              `</ul></p>`
            : ""
        }
      `;

      //SURROGATES & LITERATURE
      const surrogates = `
        <p><strong>Digital Copy:</strong> ${entry.digi ? `<a href="${entry.digi}" target="_blank">View</a>` : ""}</p>
        <p><strong>IIIF Manifest:</strong> ${entry.iiifManifest ? `<a href="${entry.iiifManifest}" target="_blank">View</a>` : ""}</p>
        <p><strong>Catalogue Entry:</strong> ${entry.cat ? `<a href="${entry.cat}" target="_blank">View</a>` : ""}</p>
      `;

      const literature = (entry.literature && entry.literature.length > 0)
        ? entry.literature.map(l => {
            const authors = (l.authors || []).map(a => `${a.surname}, ${a.forename}`).join("; ");
            const editors = (l.editors || []).length > 0 ? `ed. ${l.editors.join(", ")}` : "";
            const pages = l.citedRange ? `pp. ${l.citedRange}` : "";
            const pubDetails = [l.pubPlace, l.publisher, l.date].filter(Boolean).join(", ");
            return `<li>${authors}. <i>${l.title}</i>. ${editors ? editors + ". " : ""}${pubDetails}${pages ? `, ${pages}` : ""}.</li>`;
          }).join("")
        : "";

      //Assemble all sections
      modalBody.innerHTML = `
        ${section("File Description", fileDescription)}
        ${section("Identification", identification)}
        ${section("Content", contentSummary + contentItems)}
        ${section("Physical Description", physical)}
        ${section("History", history)}
        ${section("Surrogates & Literature", surrogates + (literature ? `<ul>${literature}</ul>` : ""))}
      `;

      const modal = new bootstrap.Modal(document.getElementById("recordModal"));
      modal.show();
    }

    function downloadJSON(entry) {
      const blob = new Blob([JSON.stringify(entry, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `${entry.msTitle?.replace(/[\\/:*?"<>|]/g, "_") || "manuscript"}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      URL.revokeObjectURL(url);
    }


    function populateFilters(entries) {
      const countries = new Set();
      const centuries = new Set();
      const persons = new Set();

      entries.forEach(entry => {
        if (entry.countryIdent) countries.add(entry.countryIdent);
        const c = getCentury(entry.dateOrigin);
        if (c) centuries.add(`C.${c}`);
        (entry.responsiblePersons || []).forEach(p => {
          persons.add(`${p.surname}, ${p.name}`);
        });
      });

      const addOptions = (selectId, values) => {
        const select = document.getElementById(selectId);
        values = Array.from(values).sort();
        values.forEach(v => {
          const option = document.createElement("option");
          option.value = v;
          option.textContent = v;
          select.appendChild(option);
        });
      };

      addOptions("countryFilter", countries);
      addOptions("centuryFilter", centuries);
      addOptions("personFilter", persons);
    }

    /*function filterTable() {
      const textFilter = document.getElementById("searchInput").value.toLowerCase();
      const country = document.getElementById("countryFilter").value;
      const century = document.getElementById("centuryFilter").value.replace("C.", "");
      const person = document.getElementById("personFilter").value.toLowerCase();

      document.querySelectorAll("#tableBody tr").forEach(row => {
        const matchesText = row.dataset.text.includes(textFilter);
        const matchesCountry = !country || row.dataset.country === country;
        const matchesCentury = !century || row.dataset.century === century;
        const matchesPerson = !person || row.dataset.persons.includes(person);

        row.style.display = matchesText && matchesCountry && matchesCentury && matchesPerson ? "" : "none";
      });
    }*/
   /*Simple filter*/
   function filterTable() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();

      document.querySelectorAll("#tableBody tr").forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? "" : "none";
      });
    }


    /*async function loadMetadata() {
      const tableBody = document.getElementById("tableBody");
      const fileList = await fetchFileList();

      for (const file of fileList) {
        try {
          const record = await fetchJSONFile(file.download_url);
          const entries = Array.isArray(record) ? record : [record];
          entries.forEach(entry => {
            allEntries.push(entry);
            const row = createTableRow(entry);
            tableBody.appendChild(row);
          });
        } catch (err) {
          console.error("Error loading file:", file.name, err);
        }
      }

      populateFilters(allEntries);
    }

    loadMetadata();*/
    </script>

    <script>
// Helper to escape XML
function escapeXml(str) {
  if (typeof str !== 'string') str = JSON.stringify(str);
  return str?.replace(/[<>&'"]/g, c => ({
    '<': '&lt;', '>': '&gt;', '&': '&amp;', '\'': '&apos;', '"': '&quot;'
  }[c])) || '';
}

// Build TEI XML for a record
function buildXML(entry) {
  const xmlWithRef = (tag, field) => {
    if (!field) return '';
    if (typeof field === 'object' && field.value) {
      return field.uri
        ? `<${tag} ref="${escapeXml(field.uri)}">${escapeXml(field.value)}</${tag}>`
        : `<${tag}>${escapeXml(field.value)}</${tag}>`;
    }
    if (typeof field === 'string') {
      return field ? `<${tag}>${escapeXml(field)}</${tag}>` : '';
    }
    return '';
  };

  return `<?xml version="1.0" encoding="UTF-8"?>
<TEI xmlns="http://www.tei-c.org/ns/1.0">
  <teiHeader>
    <fileDesc>
      <titleStmt>
        <title type="main">${escapeXml(entry.msTitle)}</title>
        ${(entry.responsiblePersons || []).map(p => `
        <respStmt${p.ref ? ` ref="${escapeXml(p.ref)}"` : ''}>
          <persName>
            <forename>${escapeXml(p.name)}</forename>
            <surname>${escapeXml(p.surname)}</surname>
            ${p.affiliation ? `<affiliation${p.affiliation.uri ? ` ref="${escapeXml(p.affiliation.uri)}"` : ''}>${escapeXml(p.affiliation.value || p.affiliation)}</affiliation>` : ''}
          </persName>
        </respStmt>`).join('')}
      </titleStmt>
      <publicationStmt>
        <availability>
          <p>${escapeXml(entry.publicationStmt)}</p>
        </availability>
      </publicationStmt>
      <sourceDesc>
        <msDesc>
          <msIdentifier>
            ${xmlWithRef('repository', entry.repository)}
            ${entry.geoRepository ? `<geo>${escapeXml(entry.geoRepository)}</geo>` : ''}
            ${xmlWithRef('settlement', entry.settlementIdent)}
            ${xmlWithRef('country', entry.countryIdent)}
            <collection><idno type="shelfmark">${escapeXml(entry.idno)}</idno></collection>
            <msName type="sigle">${escapeXml(entry.msSigle)}</msName>
            <altIdentifier><idno>${escapeXml(entry.altIdentifier)}</idno></altIdentifier>
            <msName type="full">${escapeXml(entry.msName)}</msName>
          </msIdentifier>
          <msContents>
            <summary>${escapeXml(entry.summaryContents)}</summary>
            ${(entry.msItems || []).map(item => `
            <msItem>
              ${xmlWithRef('author', item.author)}
              <title>${escapeXml(item.title)}</title>
              <locusGrp>
                ${(item.pageRanges || []).map(pr => `<locus from="${escapeXml(pr.from)}" to="${escapeXml(pr.to)}"/>`).join('\n')}
              </locusGrp>
              ${xmlWithRef('textLang', item.textLang)}
              <incipit>${escapeXml(item.incipit)}</incipit>
              <explicit>${escapeXml(item.explicit)}</explicit>
              <note type="textual-family">${escapeXml(item.textFamily)}</note>
              <note type="textual-subfamily">${escapeXml(item.textSubFamily)}</note>
              <note type="text-genre">${escapeXml(item.textGenre)}</note>
            </msItem>`).join('\n')}
          </msContents>
          <physDesc>
            <objectDesc>
              <supportDesc material="${escapeXml(entry.material)}">
                <extent>
                  <dimensions>
                    <height quantity="${escapeXml(entry.height)}" unit="cm"/>
                    <width quantity="${escapeXml(entry.width)}" unit="cm"/>
                  </dimensions>
                  <measure quantity="${escapeXml(entry.leaves)}"/>
                </extent>
                <condition>${escapeXml(entry.condition)}</condition>
              </supportDesc>
              <layoutDesc>
                <layout columns="${escapeXml(entry.columns)}" writtenLines="${escapeXml(entry.lines)}"/>
              </layoutDesc>
            </objectDesc>
            <handDesc>
              <summary>${escapeXml(entry.hands)}</summary>
            </handDesc>
            <scriptDesc>
              ${xmlWithRef('scriptNote', entry.script)}
            </scriptDesc>
          </physDesc>
          <history>
            <summary>${escapeXml(entry.summaryProvenance)}</summary>
            <origin>
              ${xmlWithRef('origPlace', entry.origPlace)}
              ${entry.geoOrigin ? `<geo>${escapeXml(entry.geoOrigin)}</geo>` : ''}
              ${xmlWithRef('country', entry.countryOrigin)}
              <origDate notBefore="${escapeXml(entry.dateOriginNotBefore)}" notAfter="${escapeXml(entry.dateOriginNotAfter)}"></origDate>
            </origin>
            ${(entry.provenance || []).map(prov => `
            <provenance>
              ${prov.type
                ? `<name type="${escapeXml(prov.type)}"${prov.name?.uri ? ` ref="${escapeXml(prov.name.uri)}"` : ''}>${escapeXml(prov.name.value || prov.name)}</name>`
                : xmlWithRef('name', prov.name)}
              <date when="${escapeXml(prov.date)}"></date>
              ${prov.geo ? `<geo>${escapeXml(prov.geo)}</geo>` : ''}
              ${xmlWithRef('settlement', prov.settlement)}
              ${xmlWithRef('country', prov.country)}
            </provenance>`).join('\n')}
          </history>
          <additional>
            <surrogates>
              ${entry.digi ? `<bibl type="digi"><title>Digital Copy</title><ref>${escapeXml(entry.digi)}</ref></bibl>` : ''}
              ${entry.iiifManifest ? `<bibl type="iiif-manifest"><title>IIIF Manifest</title><ref>${escapeXml(entry.iiifManifest)}</ref></bibl>` : ''}
              ${entry.cat ? `<bibl type="cat"><title>Catalogue Entry</title><ref>${escapeXml(entry.cat)}</ref></bibl>` : ''}
            </surrogates>
            ${(entry.literature || []).map(lit => `
            <bibl type="${escapeXml(lit.type)}">
              ${(lit.authors || []).map(a => `
              <author>
                <surname>${escapeXml(a.surname)}</surname>
                <forename>${escapeXml(a.forename)}</forename>
              </author>`).join('')}
              ${(lit.editors || []).map(e => `<editor>${escapeXml(e)}</editor>`).join('')}
              <title>${escapeXml(lit.title)}</title>
              <pubPlace>${escapeXml(lit.pubPlace)}</pubPlace>
              <publisher>${escapeXml(lit.publisher)}</publisher>
              <series>${escapeXml(lit.series)}</series>
              <date when="${escapeXml(lit.date)}"></date>
              <citedRange>${escapeXml(lit.citedRange)}</citedRange>
            </bibl>`).join('\n')}
          </additional>
        </msDesc>
      </sourceDesc>
    </fileDesc>
  </teiHeader>
  <text><body><p/></body></text>
</TEI>`;
}

// Download XML
function downloadXMLfromRecord(entry) {
  const xml = buildXML(entry);
  const blob = new Blob([xml], { type: "application/xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${entry.msTitle?.replace(/[\\/:*?"<>|]/g, "_") || "manuscript"}.xml`;
  a.click();
}

// Print PDF (browser print dialog)
function printRecordAsPDF() {
  if (!currentRecord) {
    alert("No record selected!");
    return;
  }
  const modalBody = document.getElementById("recordModalBody").innerHTML;
  const newWindow = window.open("", "_blank");
  newWindow.document.write(`
    <html>
      <head>
        <title>${currentRecord.msTitle || "Manuscript"}</title>
        <style>body { font-family: serif; }</style>
      </head>
      <body>${modalBody}</body>
    </html>
  `);
  newWindow.document.close();
  newWindow.print();
}




// Categories for filtering
const filterCategories = [
  { key: 'responsible', label: 'Responsible Persons' },
  { key: 'repository', label: 'Repositories' },
  { key: 'authors', label: 'Content Authors' },
  { key: 'languages', label: 'Text Languages' },
  { key: 'script', label: 'Font Descriptions' },
  { key: 'origin', label: 'Places of Origin' },
  { key: 'provenance', label: 'Provenance' }
];

// Store available filter options as Maps
let filterOptions = {
  responsible: new Map(),  // key=externalID or name, value={label, uri}
  repository: new Map(),
  authors: new Map(),
  languages: new Map(),
  script: new Map(),
  origin: new Map(),
  provenance: new Map()
};

// Extend table rows with dataset fields for filtering
function enrichRowDataset(row, entry) {
  // Helper: combine label + URI (if exists)
  const combo = (field) => {
    if (!field) return '';
    if (typeof field === 'object') {
      const label = (field.value || '').toLowerCase();
      const uri = (field.uri || '').toLowerCase();
      return [label, uri].filter(Boolean).join(';');
    }
    return String(field).toLowerCase();
  };

  //Responsible persons: also include external ID
  row.dataset.responsible = (entry.responsiblePersons || [])
    .map(p => {
      const name = `${p.surname || ''}, ${p.name || ''}`.toLowerCase();
      const ref = (p.ref || '').toLowerCase();
      const affil = p.affiliation?.value?.toLowerCase() || '';
      return [name, ref, affil].filter(Boolean).join(';');
    })
    .join(';');

  //Repository (label + URI)
  row.dataset.repository = combo(entry.repository);

  //Authors (each author label + URI)
  row.dataset.authors = (entry.msItems || [])
    .map(item => combo(item.author))
    .filter(Boolean)
    .join(';');

  //Languages (label + URI)
  row.dataset.languages = (entry.msItems || [])
    .map(item => combo(item.textLang))
    .filter(Boolean)
    .join(';');

  //Font/script (label + URI)
  row.dataset.script = combo(entry.script);

  //Origin (label + URI)
  row.dataset.origin = combo(entry.origPlace);

  //Provenance (each provenance name + URI)
  row.dataset.provenance = (entry.provenance || [])
    .map(prov => combo(prov.name))
    .filter(Boolean)
    .join(';');
}


// Wrap createTableRow to also enrich datasets
const originalCreateTableRow = createTableRow;
createTableRow = function(entry) {
  const row = originalCreateTableRow(entry);
  enrichRowDataset(row, entry);
  return row;
};

// Add an item to a category Map (avoids duplicates by normalized key)
function addFilterOption(map, label, uri = null) {
  if (!label) return;
  const key = (uri ? uri.trim().toLowerCase() : label.trim().toLowerCase());
  if (!map.has(key)) {
    map.set(key, { label: label.trim(), uri: uri?.trim() || null });
  }
}

// After loading all entries, collect all unique filter values
function buildFilterOptions(entries) {
  entries.forEach(entry => {
    //Responsible Persons → unique by external ID if exists
    (entry.responsiblePersons || []).forEach(p => {
      const label = `${p.surname || ''}, ${p.name || ''}`.trim();
      const ref = p.ref || null;
      addFilterOption(filterOptions.responsible, label, ref);
    });

    //Repository
    if (entry.repository?.value) addFilterOption(filterOptions.repository, entry.repository.value, entry.repository.uri);
    else if (typeof entry.repository === 'object' && entry.repository.value)
      addFilterOption(filterOptions.repository, entry.repository.value, entry.repository.uri);
    else if (typeof entry.repository === 'string')
      addFilterOption(filterOptions.repository, entry.repository);

    //Content authors & languages
    (entry.msItems || []).forEach(item => {
      if (item.author?.value) addFilterOption(filterOptions.authors, item.author.value, item.author.uri);
      if (item.textLang?.value) addFilterOption(filterOptions.languages, item.textLang.value, item.textLang.uri);
    });

    //Script
    if (entry.script?.value) addFilterOption(filterOptions.script, entry.script.value, entry.script.uri);

    //Origin
    if (entry.origPlace?.value) addFilterOption(filterOptions.origin, entry.origPlace.value, entry.origPlace.uri);

    //Provenance
    (entry.provenance || []).forEach(prov => {
      if (prov.name?.value) addFilterOption(filterOptions.provenance, prov.name.value, prov.name.uri);
    });
  });
}

// Render filters in Offcanvas dynamically
function renderFilterSidebar() {
  const container = document.getElementById('filterSections');
  container.innerHTML = '';

  filterCategories.forEach(cat => {
    const map = filterOptions[cat.key];
    if (!map || map.size === 0) return;

    // Sort alphabetically
    const values = Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label));

    const section = document.createElement('div');
    section.classList.add('mb-3');
    section.innerHTML = `<h6>${cat.label}</h6>`;

    values.forEach(item => {
      const safeVal = (item.uri ? item.uri.toLowerCase() : item.label.toLowerCase()).replace(/"/g, '&quot;');
      const linkIcon = item.uri
        ? `<a href="${item.uri}" target="_blank" class="ms-1 text-muted" data-bs-toggle="tooltip" title="Open link"><i class="fas fa-link"></i></a>`
        : '';

      section.innerHTML += `
        <div class="form-check">
          <input class="form-check-input filter-checkbox" type="checkbox"
                 data-category="${cat.key}" value="${safeVal}">
          <label class="form-check-label">
            ${item.label} ${linkIcon}
          </label>
        </div>
      `;
    });

    container.appendChild(section);
  });

  // Attach event listeners
  document.querySelectorAll('.filter-checkbox').forEach(cb =>
    cb.addEventListener('change', applyFilters)
  );

  //Activate Bootstrap tooltips for link icons
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
}

// Apply filters: search + checkboxes
function applyFilters() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

  // Collect active filters
  const activeFilters = {};
  filterCategories.forEach(cat => {
    const selected = Array.from(
      document.querySelectorAll(`.filter-checkbox[data-category="${cat.key}"]:checked`)
    ).map(cb => cb.value);
    if (selected.length > 0) activeFilters[cat.key] = selected;
  });

  document.querySelectorAll('#tableBody tr').forEach(row => {
    const rowText = row.innerText.toLowerCase();
    let visible = true;

    // Text search
    if (searchTerm && !rowText.includes(searchTerm)) visible = false;

    // Each active category must match
    for (const catKey in activeFilters) {
      const rowVal = row.dataset[catKey] || '';
      const selectedVals = activeFilters[catKey];
      const match = selectedVals.some(val => rowVal.includes(val));
      if (!match) {
        visible = false;
        break;
      }
    }

    row.style.display = visible ? '' : 'none';
  });
}

// Reset filters
document.getElementById('resetFilters')?.addEventListener('click', () => {
  document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('searchInput').value = '';
  applyFilters();
});

// After metadata loaded, build filters
async function loadMetadataWithFilters() {
  const tableBody = document.getElementById("tableBody");
  const fileList = await fetchFileList();

  for (const file of fileList) {
    try {
      const record = await fetchJSONFile(file.download_url);
      const entries = Array.isArray(record) ? record : [record];
      entries.forEach(entry => {
        allEntries.push(entry);
        const row = createTableRow(entry);
        tableBody.appendChild(row);
      });
    } catch (err) {
      console.error("Error loading file:", file.name, err);
    }
  }

  // Build filter options from loaded data
  buildFilterOptions(allEntries);
  renderFilterSidebar();
}

//Replace original loadMetadata() call
loadMetadataWithFilters();


</script>


  </body>
</html>